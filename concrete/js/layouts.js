!function(a,b){b.fn.concreteLayout=function(a){return this.each(function(){var b=$(this),d=b.data("concreteLayout");d||b.data("concreteLayout",d=new c(this,a))})};var c=function(a,b){this.options=$.extend({toolbar:"#ccm-layouts-toolbar",btnsave:"#ccm-layouts-save-button",btncancel:"#ccm-layouts-cancel-button",editing:!1,supportsgrid:!1,gridrowtmpid:"ccm-theme-grid-temp"},b),this.$element=$(a),this.$toolbar=$(this.options.toolbar),this._setupDOM(),this._setupToolbarView(),this._setupFormSaveAndCancel(),this._setupFormEvents(),this._updateChooseTypeForm()};c.prototype._setupDOM=function(){this.$formviews=this.$toolbar.find("li[data-grid-form-view]"),this.$formviewcustom=this.$toolbar.find("li[data-grid-form-view=custom]"),this.$formviewthemegrid=this.$toolbar.find("li[data-grid-form-view=themegrid]"),this.$selectgridtype=this.$toolbar.find("select[name=gridType]"),this.$selectcolumnscustom=this.$toolbar.find("input[type=text][name=columns]"),this.$customspacing=this.$toolbar.find("input[name=spacing]"),this.$customautomatedfrm=this.$toolbar.find("input[name=isautomated]"),this.$customautomated=this.$toolbar.find("[data-layout-button=toggleautomated]"),this.$selectgridcolumns=this.$toolbar.find("input[type=text][name=themeGridColumns]"),this.$savebtn=this.$toolbar.find(this.options.btnsave),this.$cancelbtn=this.$toolbar.find(this.options.btncancel),this.$slider=!1},c.prototype._setupFormSaveAndCancel=function(){var a=this;this.$cancelbtn.unbind().on("click",function(){a.$toolbar.remove(),ConcreteEvent.unsubscribe("EditModeExitInlineComplete.layouts"),ConcreteEvent.on("EditModeExitInlineComplete.layouts",function(b,c){a._rescanAreasInPage(b,c)}),ConcreteEvent.fire("EditModeExitInline")}),this.$savebtn.unbind().on("click",function(){a.$toolbar.hide().prependTo("#ccm-block-form"),$("#ccm-block-form").submit(),ConcreteEvent.unsubscribe("EditModeExitInlineComplete.layouts"),ConcreteEvent.on("EditModeExitInlineComplete.layouts",function(b,c){a._rescanAreasInPage(b,c)})})},c.prototype._rescanAreasInPage=function(){var a=Concrete.getEditMode();a.reset(),a.scanBlocks()},c.prototype._setupToolbarView=function(){var a=this;this.$formviews.each(function(){$(this).attr("data-grid-form-view")!=a.options.formview&&$(this).hide()})},c.prototype._updateChooseTypeForm=function(){var a=this.$selectgridtype.find("option:selected").val(),c=this;switch(a){case"FF":this.$formviewthemegrid.hide(),this.$formviewcustom.show(),this._updateCustomView();break;case"TG":this.$formviewcustom.hide(),this.$formviewthemegrid.show(),this._updateThemeGridView();break;default:var d=a;b.fn.dialog.showLoader();var e=CCM_TOOLS_PATH+"/area/layout_presets?arLayoutPresetID="+d+"&task=get_area_layout&ccm_token="+CCM_SECURITY_TOKEN;$.getJSON(e,function(a){c.$formviewthemegrid.hide(),c.$formviewcustom.hide(),parseInt(a.arLayout.arLayoutUsesThemeGridFramework)?(c.$formviewthemegrid.show(),c.$selectgridcolumns.val(a.arLayout.arLayoutNumColumns),c._updateThemeGridView(!0)):(c.$formviewcustom.show(),c.$selectcolumnscustom.val(a.arLayout.arLayoutNumColumns),c.$customspacing.val(a.arLayout.arLayoutSpacing),parseInt(a.arLayout.arLayoutIsCustom)?(c.$customautomatedfrm.val(0),c.$customautomated.parent().removeClass("ccm-inline-toolbar-icon-selected")):(c.$customautomated.val(1),c.$customautomated.parent().addClass("ccm-inline-toolbar-icon-selected")),c._updateCustomView(!0),parseInt(a.arLayout.arLayoutIsCustom)&&($.each(a.arLayoutColumns,function(a,b){c.columnwidths.push(parseInt(b.arLayoutColumnWidth));var d=$(c.$element.find(".ccm-layout-column").get(a));d.css("width",b.arLayoutColumnWidth+"px"),$("#ccm-edit-layout-column-width-"+a).val(b.arLayoutColumnWidth)}),c._showCustomSlider())),b.fn.dialog.hideLoader()})}this.options.editing&&this.$selectgridtype.prop("disabled",!0)},c.prototype._setupFormEvents=function(){var a=this;this.$selectcolumnscustom.on("keyup",function(){a._updateCustomView()}),this.$customspacing.on("keyup",function(){a._updateCustomView()}),this.$customautomatedfrm.on("change",function(){a._updateCustomView()}),this.$customautomated.on("click",function(){return $(this).parent().hasClass("ccm-inline-toolbar-icon-selected")?($(this).parent().removeClass("ccm-inline-toolbar-icon-selected"),a.$customautomatedfrm.val(0)):($(this).parent().addClass("ccm-inline-toolbar-icon-selected"),a.$customautomatedfrm.val(1)),a.$customautomatedfrm.trigger("change"),!1}),this.$selectgridcolumns.on("keyup",function(){a._updateThemeGridView()}),this.$selectgridtype.on("change",function(){a._updateChooseTypeForm()})},c.prototype.buildThemeGridGrid=function(){this.$element.html("");var a=this.options.rowstart;a+='<div id="ccm-theme-grid-edit-mode-row-wrapper">';var b=this._getThemeGridColumnSpan(this.columns);$.each(b,function(b,c){var d='<div id="ccm-edit-layout-column-'+b+'" class="'+c.cssClass+' ccm-theme-grid-column" data-offset="0" data-span="'+c.value+'"><div class="ccm-layout-column-highlight"><input type="hidden" id="ccm-edit-layout-column-offset-'+b+'" name="offset['+b+']" value="0" /><input type="hidden" id="ccm-edit-layout-column-span-'+b+'" name="span['+b+']" value="'+c.value+'" /></div></div>';a+=d}),a+="</div>",a+=this.options.rowend,this.$element.append(a)},c.prototype._updateThemeGridView=function(a){a||this.$selectgridtype.find("option[value=TG]").prop("selected",!0),this.columns=parseInt(this.$selectgridcolumns.val()),this.maxcolumns=parseInt(this.$selectgridcolumns.attr("data-maximum")),this.options.editing?this.$selectgridcolumns.prop("disabled",!0):this.buildThemeGridGrid(),this._resetSlider(),this.columns>1&&this._showThemeGridSlider()},c.prototype._buildThemeGridGridFromPresetColumns=function(a){this.$element.html("");var b=this.options.rowstart;b+='<div id="ccm-theme-grid-edit-mode-row-wrapper">',$.each(a,function(a,c){var d='<div id="ccm-edit-layout-column-'+a+'" class="ccm-theme-grid-column" data-offset="'+c.arLayoutColumnOffset+'" data-span="'+c.arLayoutColumnSpan+'"><div class="ccm-layout-column-highlight"><input type="hidden" id="ccm-edit-layout-column-offset-'+a+'" name="offset['+a+']" value="'+c.arLayoutColumnOffset+'" /><input type="hidden" id="ccm-edit-layout-column-span-'+a+'" name="span['+a+']" value="'+c.arLayoutColumnSpan+'" /></div></div>';b+=d}),b+="</div>",b+=this.options.rowend,this.$element.append(b),this.columns=a.length,this.maxcolumns=parseInt(this.$selectgridcolumns.attr("data-maximum")),this._resetSlider(),this._redrawThemeGrid(),this._showThemeGridSlider()},c.prototype._updateCustomView=function(a){for(a||this.$selectgridtype.find("option[value=FF]").prop("selected",!0),this.columns=parseInt(this.$selectcolumnscustom.val()),this.customspacing=this.$customspacing.val(),this.automatedcustomlayout=1==this.$customautomatedfrm.val(),this.columnwidths=[],this.options.editing&&this.$selectcolumnscustom.prop("disabled",!0),this.options.editing||this.$element.html(""),i=0;i<this.columns;i++)if(!(this.options.editing&&$("#ccm-edit-layout-column-"+i).length>0)){var b=$("<div />").attr("class","ccm-layout-column");b.attr("id","ccm-edit-layout-column-"+i);var c=$("<div />").attr("class","ccm-layout-column-highlight");c.append($("<input />",{name:"width["+i+"]",type:"hidden",id:"ccm-edit-layout-column-width-"+i})),b.append(c),this.$element.append(b)}var d=this.$element.find(".ccm-layout-column");if(this.columns<d.length)for(i=columns;i<d.length;i++)$("#ccm-edit-layout-column-"+i).remove();for(i=0;i<this.columns;i++){if(c=$("#ccm-edit-layout-column-"+i+" .ccm-layout-column-highlight"),i>0&&c.css("margin-left",this.customspacing/2+"px"),i+1<this.columns&&c.css("margin-right",this.customspacing/2+"px"),b=$("#ccm-edit-layout-column-"+i),b.attr("data-width")){var e=b.attr("data-width")+"px";this.columnwidths.push(parseInt(b.attr("data-width")))}else var e=100/this.columns+"%";b.css("width",e)}this._resetSlider(),!this.automatedcustomlayout&&this.columns>1&&this._showCustomSlider()},c.prototype._resetSlider=function(){this.$slider&&(this.$slider.slider("destroy"),this.$slider=!1),$("#ccm-area-layout-active-control-bar").hasClass("ccm-area-layout-control-bar-add")&&$("#ccm-area-layout-active-control-bar").css("height","0px")},c.prototype._getThemeGridColumnSpan=function(a){var b=Math.ceil(this.maxcolumns/a),c=[];for(i=0;a>i;i++)c[i]=b;var d=b*a;for(i=0;i<d-this.maxcolumns;i++){var e=c.length-i-1;c[e]--}var f=[];for(i=0;i<c.length;i++)f[i]={},f[i].cssClass=this.options.gridColumnClasses[c[i]-1],f[i].value=c[i];return f},c.prototype._getThemeGridNearestValue=function(a,b){var c=null;return $.each(b,function(){(null==c||Math.abs(this-a)<Math.abs(c-a))&&(c=this)}),c},c.prototype._showThemeGridSlider=function(){var a=this;a.$slider=$("#ccm-area-layout-active-control-bar"),a.$slider.css("height","6px");var b=[];for(i=0;i<a.columns;i++)m=$("#ccm-edit-layout-column-"+i),0==i?b.push(Math.floor(m.width())):i+1==a.columns?b.push(Math.floor(m.position().left)):(b.push(Math.floor(m.position().left)),b.push(Math.floor(m.width())+Math.floor(m.position().left)));var c=$("#ccm-area-layout-active-control-bar").width(),d=[],e=[],f=a.options.maxcolumns,g=a.options.gridColumnClasses[0],h=$("#ccm-theme-grid-edit-mode-row-wrapper").closest(".ccm-block-edit-layout");h.length||(h=$("#ccm-theme-grid-edit-mode-row-wrapper")),$("<div />",{id:a.options.gridrowtmpid}).appendTo(h);var j="";for(i=1;f>=i;i++)j+='<div class="'+g+'"></div>';var k=$("#"+a.options.gridrowtmpid).append($(a.options.containerstart+a.options.rowstart+j+a.options.rowend+a.options.containerend)),l=0;for(i=0;f>i;i++){var m=k.find("."+g).eq(i);if(0==i){var n=m.position().left;0>n&&(l=Math.abs(n))}d.push(Math.floor(m.position().left+l)),e.push(Math.floor(Math.floor(m.width())+Math.floor(m.position().left)+l))}$("#"+a.options.gridrowtmpid).remove(),a.$slider.slider({min:0,max:c,step:1,values:b,slide:function(c,f){"TG"!=a.$selectgridtype.val()&&a.$selectgridtype.find("option[value=TG]").prop("selected",!0);var g,h=$(f.handle).index();g=h%2==0?e:d;for(var i=0;i<b.length;i++)for(var j=0;j<g.length;j++){var k=Math.abs(b[i]-g[j]);2>=k&&(g[j]=b[i])}var l=a.$slider.slider("values",h),m=a._getThemeGridNearestValue(f.value,g),n=!0;if($.each(f.values,function(a,b){m>=b&&a>h?n=!1:b>=m&&h>a&&(n=!1)}),n&&l==m&&(n=!1),n){if(a.$slider.slider("values",h,m),h%2==0){var o=Math.floor(h/2);$innercolumn=$("#ccm-edit-layout-column-"+o);var p=parseInt($innercolumn.attr("data-span")),q=$innercolumn.nextAll(".ccm-theme-grid-column:first"),r=q.attr("data-offset");r=r?parseInt(r):0,m>l?(p++,r--):(p--,r++)}else{var o=Math.ceil(h/2);$innercolumn=$("#ccm-edit-layout-column-"+o);var p=parseInt($innercolumn.attr("data-span")),q=$innercolumn,r=q.attr("data-offset");r=r?parseInt(r):0,l>m?(p++,r--):(p--,r++)}q.attr("data-offset",r),$innercolumn.attr("data-span",p),a._redrawThemeGrid()}return!1}})},c.prototype._redrawThemeGrid=function(){var a=this;a.$element.find(".ccm-theme-grid-offset-column").remove(),$.each(a.$element.find(".ccm-theme-grid-column"),function(b,c){var d=$(c);if(d.removeClass(),d.attr("data-span")){var e=parseInt(d.attr("data-span"))-1;d.addClass(a.options.gridColumnClasses[e]),$("#ccm-edit-layout-column-span-"+b).val(parseInt(d.attr("data-span")))}if(d.attr("data-offset")){var f=parseInt(d.attr("data-offset"))-1;$("<div />",{"data-offset-column":!0}).addClass("ccm-theme-grid-offset-column").addClass(a.options.gridColumnClasses[f]).insertBefore(d),$("#ccm-edit-layout-column-offset-"+b).val(parseInt(d.attr("data-offset")))}d.addClass("ccm-theme-grid-column"),a.options.editing&&d.addClass("ccm-theme-grid-column-edit-mode")})},c.prototype._showCustomSlider=function(){this.$slider=$("#ccm-area-layout-active-control-bar"),this.$slider.css("height","6px");var a=[],b=0,c=this.$slider.width(),d=this.$element.find(".ccm-layout-column");if(this.columnwidths.length>0)for(i=0;i<this.columnwidths.length-1;i++)b+=this.columnwidths[i],a.push(b);else{var e=c/this.columns;for(i=1;i<this.columns;i++)b+=e,a.push(b)}var f=this;this.$slider.slider({min:0,max:c,step:1,values:a,create:function(){var b=0;$.each(d,function(e,f){var g=a[e];if(e+1==d.length)var h=c-b;else var h=g-b;var h=Math.floor(h);$(f).find("#ccm-edit-layout-column-width-"+e).val(h),b=g})},slide:function(a,b){"FF"!=f.$selectgridtype.val()&&f.$selectgridtype.find("option[value=FF]").prop("selected",!0);var e=0,g=!0;return $.each(b.values,function(a,b){e>b&&(g=!1),e=b}),g?(e=0,void $.each(d,function(a,f){var g;g=a+1==d.length?c-e:b.values[a]-e,g=Math.floor(g),$(f).find("#ccm-edit-layout-column-width-"+a).val(g),$(f).css("width",g+"px"),e=b.values[a]})):!1}})}}(this,jQuery);